<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard - ScrapeMaster</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .nav {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .nav a {
            color: #bb86fc;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            background: #2a2a2a;
        }
        .nav a:hover {
            background: #3700b3;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #bb86fc;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #bb86fc;
            margin: 10px 0;
        }
        .stat-label {
            color: #888;
            font-size: 14px;
            text-transform: uppercase;
        }
        .chart-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .chart-title {
            color: #bb86fc;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('jobs_list') }}">Jobs</a>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
        </div>

        <h1>Analytics Dashboard</h1>
        <p class="subtitle">Visualize your scraping performance and statistics</p>

        <div id="dashboard-root"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Dashboard() {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                fetchStats();
            }, []);

            useEffect(() => {
                if (stats && !loading) {
                    renderCharts();
                }
            }, [stats, loading]);

            async function fetchStats() {
                try {
                    const response = await fetch('/api/stats');
                    if (!response.ok) throw new Error('Failed to fetch stats');
                    const data = await response.json();
                    setStats(data);
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            }

            function renderCharts() {
                // Data Type Distribution Chart
                if (stats.data_type_distribution && Object.keys(stats.data_type_distribution).length > 0) {
                    const ctx1 = document.getElementById('dataTypeChart');
                    if (ctx1) {
                        new Chart(ctx1, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(stats.data_type_distribution),
                                datasets: [{
                                    data: Object.values(stats.data_type_distribution),
                                    backgroundColor: ['#bb86fc', '#03dac6', '#cf6679', '#ffa726']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        labels: { color: '#fff' }
                                    }
                                }
                            }
                        });
                    }
                }

                // Recent Activity Chart
                if (stats.recent_activity && stats.recent_activity.length > 0) {
                    const ctx2 = document.getElementById('activityChart');
                    if (ctx2) {
                        new Chart(ctx2, {
                            type: 'line',
                            data: {
                                labels: stats.recent_activity.map(item => item.date),
                                datasets: [{
                                    label: 'Scraping Runs',
                                    data: stats.recent_activity.map(item => item.count),
                                    borderColor: '#bb86fc',
                                    backgroundColor: 'rgba(187, 134, 252, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        labels: { color: '#fff' }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { color: '#fff' },
                                        grid: { color: '#444' }
                                    },
                                    y: {
                                        ticks: { color: '#fff' },
                                        grid: { color: '#444' }
                                    }
                                }
                            }
                        });
                    }
                }

                // Top Sites Chart
                if (stats.top_sites && stats.top_sites.length > 0) {
                    const ctx3 = document.getElementById('topSitesChart');
                    if (ctx3) {
                        new Chart(ctx3, {
                            type: 'bar',
                            data: {
                                labels: stats.top_sites.map(site => {
                                    const url = new URL(site.url);
                                    return url.hostname;
                                }),
                                datasets: [{
                                    label: 'Scrape Count',
                                    data: stats.top_sites.map(site => site.count),
                                    backgroundColor: '#03dac6'
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        labels: { color: '#fff' }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { color: '#fff' },
                                        grid: { color: '#444' }
                                    },
                                    y: {
                                        ticks: { color: '#fff' },
                                        grid: { color: '#444' }
                                    }
                                }
                            }
                        });
                    }
                }
            }

            if (loading) {
                return <div className="loading">Loading dashboard data...</div>;
            }

            if (error) {
                return <div className="loading" style={{color: '#cf6679'}}>Error: {error}</div>;
            }

            if (!stats) {
                return <div className="loading">No data available</div>;
            }

            return (
                <>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Jobs</div>
                            <div className="stat-value">{stats.total_jobs || 0}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Active Jobs</div>
                            <div className="stat-value">{stats.active_jobs || 0}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Total Items</div>
                            <div className="stat-value">{stats.total_items || 0}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Success Rate</div>
                            <div className="stat-value">{stats.success_rate ? stats.success_rate.toFixed(1) : 0}%</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Avg Time (s)</div>
                            <div className="stat-value">{stats.avg_execution_time || 0}</div>
                        </div>
                    </div>

                    <div className="charts-grid">
                        {stats.data_type_distribution && Object.keys(stats.data_type_distribution).length > 0 && (
                            <div className="chart-container">
                                <div className="chart-title">Data Type Distribution</div>
                                <canvas id="dataTypeChart"></canvas>
                            </div>
                        )}

                        {stats.top_sites && stats.top_sites.length > 0 && (
                            <div className="chart-container">
                                <div className="chart-title">Top Scraped Sites</div>
                                <canvas id="topSitesChart"></canvas>
                            </div>
                        )}
                    </div>

                    {stats.recent_activity && stats.recent_activity.length > 0 && (
                        <div className="chart-container">
                            <div className="chart-title">Recent Activity (Last 7 Days)</div>
                            <canvas id="activityChart"></canvas>
                        </div>
                    )}

                    {(!stats.total_jobs || stats.total_jobs === 0) && (
                        <div className="loading">
                            <h2>No Data Yet</h2>
                            <p>Create some scraping jobs and run them to see analytics!</p>
                        </div>
                    )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('dashboard-root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
